<label id="theme-toggle" class="theme-toggle" title="Toggle theme">
  <input type="checkbox" />
  <span class="theme-toggle-sr">Toggle theme</span>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    aria-hidden="true"
    width="1em"
    height="1em"
    fill="currentColor"
    stroke-linecap="round"
    class="theme-toggle__classic"
    viewBox="0 0 32 32"
  >
    <clipPath id="theme-toggle__classic__cutout">
      <path d="M0-5h30a1 1 0 0 0 9 13v24H0Z"></path>
    </clipPath>
    <g clip-path="url(#theme-toggle__classic__cutout)">
      <circle cx="16" cy="16" r="9.34"></circle>
      <g stroke="currentColor" stroke-width="1.5">
        <path d="M16 5.5v-4"></path>
        <path d="M16 30.5v-4"></path>
        <path d="M1.5 16h4"></path>
        <path d="M26.5 16h4"></path>
        <path d="m23.4 8.6 2.8-2.8"></path>
        <path d="m5.7 26.3 2.9-2.9"></path>
        <path d="m5.8 5.8 2.8 2.8"></path>
        <path d="m23.4 23.4 2.9 2.9"></path>
      </g>
    </g>
  </svg>
</label>

<script>
  const storageKey = "theme-preference";

  const onClick = (e) => {
    // flip current value
    theme.value = e.target.checked === true ? "dark" : "light";

    setPreference();
  };

  const getColorPreference = () => {
    if (localStorage.getItem(storageKey)) return localStorage.getItem(storageKey);
    else return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  };

  const setPreference = () => {
    localStorage.setItem(storageKey, theme.value);
    reflectPreference();
  };

  const reflectPreference = () => {
    document.firstElementChild.setAttribute("data-theme", theme.value);

    document.querySelector("#theme-toggle")?.setAttribute("aria-label", theme.value);
  };

  const theme = {
    value: getColorPreference(),
  };

  // set early so no page flashes / CSS is made aware
  reflectPreference();

  window.onload = () => {
    // set on load so screen readers can see latest value on the button
    reflectPreference();

    // now this script can find and listen for clicks on the control
    document.querySelector("#theme-toggle").addEventListener("click", onClick);
  };

  // sync with system changes
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches: isDark }) => {
    theme.value = isDark ? "dark" : "light";
    setPreference();
  });
</script>
